from hashlib import sha256
from Crypto.Cipher import AES
from Crypto.Util.Padding import unpad
from base64 import b64decode
import string

# Dữ liệu đầu vào
password = "UxcWc8uXFk4%b~IR0NAz54kLDwcIo0IYj^hkNwHL7RfZizOQly3Zykm*&9cXuCx*s@F5WlG!&GV&zneOvzgeGYt3IdUw1PD%p&vS#voUy5Yadfq!seHfz5hOhWFQvzM6Whj3gaRQ$p8Mbx&&xOXDIC%MqvNOCgQ*2Z!1uE"
ciphertext_b64 = "BFw5r152xU41dF4v3j6QrSBWYJUrwulo/dlvvdW8FrOgo2KZdmOmmAeRoHylDcvn"

ALPHABET = string.ascii_letters + string.digits + '~!@#$%^&*'
half = len(ALPHABET) // 2

# Lấy bit từ password
bits = []
for c in password:
    if c in ALPHABET[:half]:
        bits.append(1)
    elif c in ALPHABET[half:]:
        bits.append(0)
    else:
        raise ValueError(f"Unknown character: {c}")

# Tạo lại master_key từ bit
master_key_int = 0
for i, bit in enumerate(bits):
    if bit:
        master_key_int |= (1 << i)

master_key = master_key_int.to_bytes((master_key_int.bit_length() + 7) // 8, 'little')

# Tạo AES key và giải mã
key = sha256(master_key).digest()
cipher = AES.new(key, AES.MODE_ECB)
plaintext = unpad(cipher.decrypt(b64decode(ciphertext_b64)), 16)

print("Recovered FLAG:", plaintext.decode())
